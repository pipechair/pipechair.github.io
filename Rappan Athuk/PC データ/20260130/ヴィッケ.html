<!DOCTYPE html>
<!-- saved from url=(0045)https://dragonlance.jp/fvtt-5e-pc-viewer.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FVTT D&amp;D5e Character Sheet Viewer</title>
<style>
:root{--bg:#1a1714;--sf:#242018;--sf2:#2e2820;--bd:#3e362a;--bda:#8b7340;--tx:#e8e2d6;--tm:#9e9486;--td:#6e6458;--ac:#c9a84c;--acd:#7a6630;--red:#c44040;--grn:#48a848;--blu:#5588cc}
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;height:100%}
body{background:var(--bg);color:var(--tx);font:14px/1.5 'Segoe UI',system-ui,-apple-system,'Hiragino Kaku Gothic ProN',Meiryo,sans-serif}

/* Toolbar */
.toolbar{background:var(--sf);border-bottom:1px solid var(--bd);padding:10px 16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;position:sticky;top:0;z-index:100;backdrop-filter:blur(6px)}
.toolbar-title{font-size:15px;font-weight:700;color:var(--ac);margin-right:auto}
.btn,input[type=file]{background:var(--sf2);border:1px solid var(--bd);color:var(--tx);padding:6px 12px;border-radius:6px;font-size:13px}
.btn{cursor:pointer;transition:border-color .15s}
.btn:hover{border-color:var(--ac)}
.btn-export{background:#2a3020;border-color:#4a6030;color:#a0d070}
.btn-export:hover{border-color:#80c040}
select.btn{appearance:auto}

.dropzone{border:2px dashed var(--bd);border-radius:12px;padding:24px;text-align:center;color:var(--tm);margin:16px;transition:.2s}
.dropzone.drag{border-color:var(--ac);color:var(--tx);background:rgba(201,168,76,.05)}

/* Sheet */
.sheet{max-width:1120px;margin:0 auto;padding:12px 16px 48px;display:none}
.sheet.active{display:block}

/* Header */
.char-header{text-align:center;padding:20px 0 14px;border-bottom:2px solid var(--bda);margin-bottom:16px}
.char-name{font-size:30px;font-weight:700;letter-spacing:.04em}
.char-sub{font-size:14px;color:var(--tm);margin-top:4px}

/* 3-column body */
.sheet-body{display:grid;grid-template-columns:86px minmax(220px,1fr) minmax(300px,1.4fr);gap:12px;margin-bottom:16px}

/* Ability boxes */
.ab-col{display:flex;flex-direction:column;gap:16px}
.ab-box{position:relative;border:2px solid var(--bda);border-radius:8px;padding:8px 4px 22px;text-align:center;background:var(--sf)}
.ab-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ac)}
.ab-score{font-size:26px;font-weight:700;line-height:1.2}
.ab-mod{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);width:36px;height:28px;display:flex;align-items:center;justify-content:center;border:2px solid var(--bda);border-radius:14px;background:var(--sf);font-size:14px;font-weight:700}

/* Panels */
.panel{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:10px 12px}
.panel+.panel{margin-top:10px}
.p-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ac);text-align:center;padding-bottom:5px;border-bottom:1px solid var(--bd);margin-bottom:6px}

/* Prof & Inspiration */
.prof-row{display:flex;gap:8px;margin-bottom:10px}
.prof-box{flex:1;display:flex;align-items:center;gap:8px;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:8px 10px}
.prof-box .big{font-size:22px;font-weight:700;color:var(--ac);min-width:34px;text-align:center}
.prof-box .lbl{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--tm);line-height:1.3}

/* Dot */
.dot{display:inline-block;width:10px;height:10px;border:1.5px solid var(--ac);border-radius:50%;flex-shrink:0;margin-right:5px;vertical-align:middle}
.dot.full{background:var(--ac)}
.dot.half{background:linear-gradient(90deg,var(--ac) 50%,transparent 50%)}
.dot.expert{background:var(--ac);box-shadow:0 0 0 2px var(--sf),0 0 0 3.5px var(--ac)}

/* Save / Skill rows */
.s-row{display:flex;align-items:center;padding:2.5px 0;font-size:13px}
.s-row .bonus{min-width:30px;text-align:right;font-weight:600;margin-right:6px}
.s-row .name{flex:1}
.s-row .abil{font-size:10px;color:var(--td);text-transform:uppercase;margin-left:3px}

/* Passive */
.passive{display:flex;align-items:center;background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:6px 10px;margin-top:10px}
.passive .big{font-size:20px;font-weight:700;min-width:32px;text-align:center;margin-right:8px}
.passive .lbl{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--tm)}

/* Combat trio */
.combat-trio{display:flex;gap:8px;margin-bottom:10px}
.c-box{flex:1;text-align:center;border:2px solid var(--bda);border-radius:8px;padding:6px 4px;background:var(--sf)}
.c-box .lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ac)}
.c-box .val{font-size:26px;font-weight:700}
.c-box .unit{font-size:11px;color:var(--tm)}

/* HP */
.hp-panel{border:2px solid var(--bda);border-radius:8px;padding:10px;background:var(--sf);margin-bottom:10px}
.hp-row{display:flex;justify-content:center;align-items:center;gap:6px}
.hp-cur{font-size:28px;font-weight:700;width:60px;text-align:center;background:transparent;border:1px solid var(--bd);border-radius:6px;color:var(--tx);font-family:inherit}
.hp-cur:focus{border-color:var(--ac);outline:none}
.hp-sep{color:var(--td);font-size:20px;font-weight:700}
.hp-max{font-size:28px;font-weight:700}
.hp-bar{height:6px;background:var(--sf2);border-radius:3px;overflow:hidden;margin:6px 0}
.hp-bar-fill{height:100%;border-radius:3px;transition:width .3s,background .3s}
.hp-adj{display:flex;justify-content:center;gap:6px;margin-top:6px}
.hp-adj-input{width:50px;text-align:center;background:var(--sf2);border:1px solid var(--bd);border-radius:4px;color:var(--tx);font-size:13px;padding:3px}
.hp-adj-input:focus{border-color:var(--ac);outline:none}
.hp-btn{padding:3px 10px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:700;border:1px solid}
.hp-btn-dmg{background:#3a2020;border-color:#804040;color:#e08080}
.hp-btn-dmg:hover{background:#4a2020;border-color:#c04040}
.hp-btn-heal{background:#203a20;border-color:#408040;color:#80e080}
.hp-btn-heal:hover{background:#204a20;border-color:#40c040}
.hp-temp-row{display:flex;justify-content:center;align-items:center;gap:4px;margin-top:4px;font-size:12px;color:var(--blu)}
.hp-temp-input{width:40px;text-align:center;background:transparent;border:1px solid var(--bd);border-radius:4px;color:var(--blu);font-size:12px;padding:2px;font-family:inherit}
.hp-temp-input:focus{border-color:var(--ac);outline:none}

/* HD & Death */
.hd-death{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.mini-p{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:8px;text-align:center}
.mini-p .lbl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--ac);margin-bottom:3px}
.dd{display:flex;justify-content:center;gap:5px;margin:2px 0}
.dd .d{width:14px;height:14px;border:1.5px solid var(--td);border-radius:50%;cursor:pointer;transition:all .15s}
.dd .d:hover{border-color:var(--ac);transform:scale(1.2)}
.dd .d.ok{background:var(--grn);border-color:var(--grn)}
.dd .d.ng{background:var(--red);border-color:var(--red)}

/* Tables */
.t{width:100%;border-collapse:collapse;font-size:13px}
.t th{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--tm);font-weight:600;text-align:left;padding:4px 6px;border-bottom:1px solid var(--bd)}
.t td{padding:4px 6px;border-bottom:1px solid rgba(62,54,42,.4);vertical-align:top}

/* Hide native number spinner */
input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield}

/* Inline edit inputs */
.e-num{width:42px;text-align:center;background:transparent;border:1px solid var(--bd);border-radius:4px;color:var(--tx);font-size:13px;padding:2px 4px;font-family:inherit}
.e-num:focus{border-color:var(--ac);outline:none}
.e-coin{width:48px;text-align:center;background:transparent;border:1px solid var(--bd);border-radius:4px;font-size:13px;padding:2px 4px;font-family:inherit}
.e-coin:focus{border-color:var(--ac);outline:none}
.coin-pp .e-coin{color:#b0b8cc}
.coin-gp .e-coin{color:#d4a848}
.coin-ep .e-coin{color:#8898a8}
.coin-sp .e-coin{color:#a8b0b8}
.coin-cp .e-coin{color:#b88860}

/* Number control +/- buttons */
.nc{display:inline-flex;align-items:center;gap:2px;vertical-align:middle}
.nc-btn{width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--bd);border-radius:5px;background:var(--sf2);color:var(--tm);font-size:16px;font-weight:700;cursor:pointer;user-select:none;line-height:1;padding:0;transition:all .12s}
.nc-btn:hover{border-color:var(--ac);color:var(--tx);background:var(--sf)}
.nc-btn:active{transform:scale(.9);background:var(--bda);color:var(--bg)}
.nc .e-num,.nc .e-coin{border-radius:0;border-left:none;border-right:none}
.nc .nc-btn:first-child{border-radius:5px 0 0 5px}
.nc .nc-btn:last-child{border-radius:0 5px 5px 0}

/* Clickable toggles */
.clickable{cursor:pointer;user-select:none;transition:transform .1s}
.clickable:hover{transform:scale(1.15)}
.clickable:active{transform:scale(.95)}

/* Full-width sections */
.sec{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:12px 14px;margin-bottom:12px}
.sec-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ac);border-bottom:1px solid var(--bd);padding-bottom:5px;margin-bottom:8px}

/* Personality grid */
.pers-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.pers-box{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:10px 12px}
.pers-box .lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ac);margin-bottom:3px}
.pers-box .ct{font-size:13px;color:var(--tm);line-height:1.5}

/* Prof & Languages */
.pl-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.pl-grp .lbl{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--ac);margin-bottom:3px}
.pl-grp .items{font-size:12px;color:var(--tm)}
.pill{display:inline-block;border:1px solid var(--bd);border-radius:999px;padding:1px 8px;margin:2px 3px 2px 0;font-size:12px}

/* Spells */
.sp-meta{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:8px;font-size:13px}
.sp-meta b{color:var(--tm);font-weight:600}
.sp-slots{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;font-size:12px}
.sl-grp{display:flex;align-items:center;gap:3px}
.sl-grp .lv{font-size:11px;color:var(--tm);min-width:26px}
.sl-d{width:14px;height:14px;border:1.5px solid var(--acd);border-radius:50%;cursor:pointer;transition:all .15s}
.sl-d:hover{border-color:var(--ac);transform:scale(1.2)}
.sl-d.on{background:var(--ac);border-color:var(--ac)}
.sp-lv{border:1px solid var(--bd);border-radius:8px;margin-bottom:6px}
.sp-lv summary{cursor:pointer;padding:6px 10px;font-size:13px;font-weight:600;user-select:none}
.sp-lv summary:hover{color:var(--ac)}
.sp-lv-body{padding:0 10px 8px}
.sp-entry{display:flex;align-items:flex-start;gap:6px;padding:3px 0;font-size:13px;border-bottom:1px solid rgba(62,54,42,.3)}
.sp-entry:last-child{border-bottom:none}
.sp-entry .prep{color:var(--grn);font-size:14px;flex-shrink:0;width:18px;text-align:center;cursor:pointer;user-select:none;transition:transform .1s}
.sp-entry .prep:hover{transform:scale(1.3)}
.sp-entry .prep.off{color:var(--td)}
.sp-entry .sn{font-weight:600;min-width:110px}
.sp-entry .sd{font-size:12px;color:var(--tm);flex:1}

/* Features */
.feat-item{border-bottom:1px solid rgba(62,54,42,.4);padding:5px 0}
.feat-item:last-child{border-bottom:none}
.feat-item .fn{font-weight:600;font-size:13px}
.feat-item .fs{font-size:11px;color:var(--td);margin-left:6px}
.feat-item .fd{font-size:12px;color:var(--tm);margin-top:2px;line-height:1.5}
.feat-uses{display:inline-flex;align-items:center;gap:3px;margin-left:8px;font-size:12px;color:var(--blu)}

/* Currency */
.coins{display:flex;gap:14px;justify-content:center;padding:6px 0;font-size:13px}
.coin{display:flex;align-items:center;gap:3px}
.coin .cl{font-size:11px;font-weight:700;text-transform:uppercase}
.coin-pp .cl{color:#b0b8cc}
.coin-gp .cl{color:#d4a848}
.coin-ep .cl{color:#8898a8}
.coin-sp .cl{color:#a8b0b8}
.coin-cp .cl{color:#b88860}

/* Equipped toggle */
.eq-toggle{cursor:pointer;user-select:none;font-size:14px}
.eq-toggle:hover{filter:brightness(1.3)}

/* Bio */
.bio-ct{font-size:13px;line-height:1.7;color:var(--tm)}
.bio-ct h1,.bio-ct h2,.bio-ct h3{color:var(--tx);margin:10px 0 4px}

/* Responsive */
@media(max-width:900px){
  .sheet-body{grid-template-columns:1fr}
  .ab-col{flex-direction:row;flex-wrap:wrap;justify-content:center;gap:10px}
  .pers-grid{grid-template-columns:1fr}
  .pl-grid{grid-template-columns:1fr}
}
@media(max-width:600px){
  body{font-size:13px}
  .toolbar{padding:8px 10px;gap:6px}
  .toolbar-title{font-size:13px;width:100%}
  input[type=file]{font-size:11px;max-width:160px;overflow:hidden}
  .btn{padding:5px 8px;font-size:12px}
  .dropzone{margin:8px;padding:16px;font-size:13px}
  .sheet{padding:8px 8px 40px}
  .char-name{font-size:22px}
  .char-sub{font-size:12px}
  .combat-trio{flex-wrap:wrap}
  .c-box{min-width:0}
  .c-box .val{font-size:22px}
  .hp-cur{font-size:22px;width:50px}
  .hp-max{font-size:22px}
  .hp-adj{flex-wrap:wrap;gap:4px}
  .hp-btn{padding:6px 12px;font-size:13px}
  .hd-death{grid-template-columns:1fr}
  .coins{flex-wrap:wrap;gap:8px}
  .coin{gap:2px}
  .nc-btn{width:30px;height:30px;font-size:18px}
  .nc{gap:1px}
  .e-num{width:38px;font-size:12px}
  .e-coin{width:42px;font-size:12px}
  .sp-entry{flex-wrap:wrap}
  .sp-entry .sn{min-width:0}
  .sp-entry .sd{width:100%;padding-left:24px}
  .sp-slots{gap:8px}
  .sec{padding:10px 8px}
  .panel{padding:8px}
  /* Tables scroll horizontally if needed */
  .panel,.sec{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .t{min-width:280px}
  .t th,.t td{padding:4px 4px;font-size:12px}
  .prof-row{flex-wrap:wrap}
  .prof-box{padding:6px 8px}
  .feat-item .fn{font-size:12px}
  .feat-item .fd{font-size:11px}
  .pl-grp{margin-bottom:6px}
}
.text-m{color:var(--tm)}
.text-d{color:var(--td)}
.text-s{font-size:12px}
/* Prevent horizontal overflow */
html{overflow-x:hidden}
.sheet,.sec,.panel{max-width:100%}

/* Item tooltip */
.tip{position:relative;cursor:help;border-bottom:1px dotted var(--td)}
.tip .tip-body{display:none;position:absolute;left:0;top:calc(100% + 6px);width:min(360px,85vw);background:var(--sf);border:1px solid var(--bda);border-radius:8px;padding:10px 12px;font-size:12px;line-height:1.6;color:var(--tm);text-align:left;white-space:normal;z-index:200;box-shadow:0 4px 16px rgba(0,0,0,.5);font-weight:400;pointer-events:none}
.tip:hover .tip-body,.tip:focus .tip-body{display:block}

/* Footer */
.site-footer{text-align:center;padding:16px;font-size:11px;color:var(--td);border-top:1px solid var(--bd);margin-top:24px}
.mit-tip{position:relative;display:inline;cursor:help;color:var(--tm);text-decoration:underline dotted var(--td);text-underline-offset:2px}
.mit-tip .mit-body{display:none;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);width:min(480px,90vw);background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:12px 14px;font-size:11px;line-height:1.6;color:var(--tm);text-align:left;white-space:pre-wrap;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,.5)}
.mit-tip:hover .mit-body,.mit-tip:focus .mit-body{display:block}
</style>
</head>
<body>
<div class="toolbar">
  <span class="toolbar-title">D&amp;D 5e Character Sheet</span>
  <input id="file" type="file" accept=".json,application/json">
  <button class="btn" id="demoBtn">Demo Sample</button>
  <button class="btn btn-export" id="exportBtn" style="display: inline-block;">Export JSON</button>
  <select id="actorSel" class="btn" style="display:none"></select>
</div>
<div id="dropzone" class="dropzone" style="display: none;">
  JSONファイルをドラッグ＆ドロップ / ファイル選択で読み込み<br>
  <span class="text-s text-m">Foundry VTT D&amp;D5e Actor JSON対応 — すべてローカル処理</span>
</div>
<div id="sheet" class="sheet active"><div class="char-header"><div class="char-name">ヴィッケ（ヴァイケル）・ハルベール</div><div class="char-sub">バーバリアン (荒ぶる魔力の道) Lv5 · ハーフエルフ · 騎士 · — · 9100 XP</div></div><div class="sheet-body"><div class="ab-col"><div class="ab-box"><div class="ab-lbl">STR</div><div class="ab-score">18</div><div class="ab-mod">+4</div></div><div class="ab-box"><div class="ab-lbl">DEX</div><div class="ab-score">12</div><div class="ab-mod">+1</div></div><div class="ab-box"><div class="ab-lbl">CON</div><div class="ab-score">19</div><div class="ab-mod">+4</div></div><div class="ab-box"><div class="ab-lbl">INT</div><div class="ab-score">14</div><div class="ab-mod">+2</div></div><div class="ab-box"><div class="ab-lbl">WIS</div><div class="ab-score">10</div><div class="ab-mod">+0</div></div><div class="ab-box"><div class="ab-lbl">CHA</div><div class="ab-score">10</div><div class="ab-mod">+0</div></div></div><div><div class="prof-row"><div class="prof-box"><div class="big clickable" data-action="toggle-inspiration">★</div><div class="lbl">Inspiration</div></div><div class="prof-box"><div class="big">+3</div><div class="lbl">習熟ボーナス</div></div></div><div class="panel"><div class="p-title">セーヴィング・スロー</div><div class="s-row"><div class="dot full"></div><div class="bonus">+7</div><div class="name">筋力</div></div><div class="s-row"><div class="dot "></div><div class="bonus">+1</div><div class="name">敏捷</div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+7</div><div class="name">耐久</div></div><div class="s-row"><div class="dot "></div><div class="bonus">+2</div><div class="name">知力</div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">判断</div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">魅力</div></div></div><div class="panel"><div class="p-title">技能</div><div class="s-row"><div class="dot "></div><div class="bonus">+1</div><div class="name">軽業<span class="abil">dex</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">動物使い<span class="abil">wis</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+5</div><div class="name">魔法学<span class="abil">int</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+7</div><div class="name">運動<span class="abil">str</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">ペテン<span class="abil">cha</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+5</div><div class="name">歴史<span class="abil">int</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">看破<span class="abil">wis</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">威圧<span class="abil">cha</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+2</div><div class="name">捜査<span class="abil">int</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">医術<span class="abil">wis</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+5</div><div class="name">自然<span class="abil">int</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+3</div><div class="name">知覚<span class="abil">wis</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+0</div><div class="name">芸能<span class="abil">cha</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+3</div><div class="name">説得<span class="abil">cha</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+2</div><div class="name">宗教<span class="abil">int</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+1</div><div class="name">手先の早業<span class="abil">dex</span></div></div><div class="s-row"><div class="dot "></div><div class="bonus">+1</div><div class="name">隠密<span class="abil">dex</span></div></div><div class="s-row"><div class="dot full"></div><div class="bonus">+3</div><div class="name">生存<span class="abil">wis</span></div></div></div><div class="passive"><div class="big">13</div><div class="lbl">受動知覚 (Passive Perception)</div></div></div><div><div class="combat-trio"><div class="c-box"><div class="lbl">AC</div><div class="val">15</div></div><div class="c-box"><div class="lbl">イニシアチブ</div><div class="val">+1</div></div><div class="c-box"><div class="lbl">移動速度</div><div class="val">30</div><div class="unit">ft</div></div></div><div class="hp-panel"><div class="p-title">ヒットポイント</div><div class="hp-row"><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="hp-cur" data-action="set-hp" value="56" min="0" max="56"><button type="button" class="nc-btn" data-nc="1">+</button></span><span class="hp-sep">/</span><span class="hp-max">56</span></div><div class="hp-bar"><div class="hp-bar-fill" style="width:100%;background:var(--grn)"></div></div><div class="hp-adj"><button class="hp-btn hp-btn-dmg" data-action="hp-dmg">Damage</button><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="hp-adj-input" id="hpDelta" value="0" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span><button class="hp-btn hp-btn-heal" data-action="hp-heal">Heal</button></div><div class="hp-temp-row">一時HP: <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="hp-temp-input" data-action="set-temp-hp" value="0" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></div></div><div class="hd-death"><div class="mini-p"><div class="lbl">ヒットダイス</div><div style="margin:3px 0"><span class="text-s">d12</span> <span style="font-weight:700">5</span>/5 <button class="hp-btn hp-btn-dmg" style="font-size:10px;padding:1px 6px" data-action="hd-use" data-class-idx="0">使用</button> <button class="hp-btn hp-btn-heal" style="font-size:10px;padding:1px 6px" data-action="hd-recover" data-class-idx="0">回復</button></div></div><div class="mini-p"><div class="lbl">デス・セーヴ</div><div class="text-s">成功</div><div class="dd"><div class="d " data-action="death-success" data-idx="0"></div><div class="d " data-action="death-success" data-idx="1"></div><div class="d " data-action="death-success" data-idx="2"></div></div><div class="text-s">失敗</div><div class="dd"><div class="d " data-action="death-failure" data-idx="0"></div><div class="d " data-action="death-failure" data-idx="1"></div><div class="d " data-action="death-failure" data-idx="2"></div></div></div></div><div class="panel"><div class="p-title">攻撃</div><table class="t"><thead><tr><th>名称</th><th>攻撃</th><th>ダメージ</th></tr></thead><tbody><tr><td><span class="tip" tabindex="0">ジャヴェリン<span class="tip-body">この軽くて扱いやすい槍は投擲用に作られているが、近接戦闘でも使用できるほど幅広い用途で役立つ。</span></span></td><td>+7</td><td>—</td></tr><tr><td><span class="tip" tabindex="0">素手打撃<span class="tip-body">パンチ、キック、頭突き、または類似の強力な一撃（いずれも武器としてカウントされない）。ヒットした場合、素手打撃は1+君の【筋力】修正値に等しい打撃ダメージを与える。君は素手打撃に習熟している。</span></span></td><td>+7</td><td>—</td></tr><tr><td><span class="tip" tabindex="0">ウォーハンマー<span class="tip-body">片手で持って盾を使用するか、あるいは両手で振り回すか、どちらにしても強力な打撃を与えることができる金属製のハンマー。</span></span></td><td>+7</td><td>—</td></tr><tr><td><span class="tip" tabindex="0">ダーツ<span class="tip-body">羽根が付いたの木の軸に、金属または木製の鋭い先端が付いた小さな投擲具。ダーツは表皮を貫くのに十分な威力を持つ。</span></span></td><td>+4</td><td>—</td></tr><tr><td><span class="tip" tabindex="0">ロングソード +1<span class="tip-body">悪魔の加護、天界の遺物、狂気の実験、熟練の技など、この武器は持ち主にさらなる流血をもたらすよう強化されている。
君はこの魔法の武器で行う攻撃とダメージのロールにボーナスを得ることができる。</span></span></td><td>+8</td><td>— +1</td></tr><tr><td><span class="tip" tabindex="0">アダマンティン・グレートソード<span class="tip-body">軍用武器, 近接武器, メジャー, 不明
			
				6 lb.
				2d6 slashing  - 両手用, 重武器
			
		
		
		アダマンテインの武器が物体にヒットしたなら、そのヒットはクリティカル・ヒットになる。この強力な両手剣は長さ４フィート以上、幅約5インチの刃を持つ。この武器の扱いには広範な武器の訓練を必要とするが、その扱いに長けた使い手となれば手ごわい相手だろう。 重武器. 小型サイズのクリーチャーは“重武器”の特性を持つ武器を用いた攻撃ロールに“不利”を被る。重武器は大きく重いため、小型クリーチャーには使いこなせないのだ 両手用. “両手用”の特性を持つ武器で攻撃を行なうには2本の手を要する。持つだけならば1本の手でよい。</span></span></td><td>+7</td><td>—</td></tr></tbody></table></div><div class="panel"><div class="p-title">装備・所持品</div><table class="t"><thead><tr><th>名称</th><th>種別</th><th>数</th></tr></thead><tbody><tr><td><span class="tip" tabindex="0">印章指輪<span class="tip-body">ある家系や組織などの所属や階級を示す、独自のデザインが施された指輪。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="6" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">家系図<span class="tip-body">君の出自を証明する家系図。これを見れば君に連なる一族の名前と称号がわかる。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="7" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">財布<span class="tip-body">君のお財布。革張りの長財布だったり、適当な布袋だったり、出自や由来によって形状は様々だ。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="8" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class=" eq-toggle" style="color:var(--grn)" data-action="toggle-equip" data-item-idx="12">◆</span> <span class="tip" tabindex="0">シールド<span class="tip-body">シールドは木または金属でできており、片手で使用する。シールドを装備すると、ＡＣが2増加する。また、シールドから得られるこのボーナスは、一度に1枚のシールドからしか得られない。</span></span></td><td class="text-s text-m">equipment</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="12" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">探検家パック<span class="tip-body">背負い袋には、1立方フィートまたは30ポンドの道具を入れることができます。また、バックパックの外側に、ベッドロールやロープのコイルなどのアイテムをストラップで取り付けることもできます。</span></span></td><td class="text-s text-m">container</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="13" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ほくち箱<span class="tip-body">この小箱の中には、火打ち石と打ち金、ほくちが入っている。君は1回のアクションとして、松明や、その他の引火性の強い可燃物に火を付けることができる。それ以外のものに火を付けるには1分かかる。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="14" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">トーチ<span class="tip-body">たいまつは、半径20フィートまでを明るく照らし、その先20フィートまでを薄暗い明かりで照らす。たいまつは1時間、燃え続ける。君は火の付いた たいまつで近接攻撃を行なうこともでき、命中したなら1[火]ダメージを与える。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="15" value="10" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">携帯用寝具<span class="tip-body">旅人が寝るときに使う、丸められた布。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="16" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">保存食<span class="tip-body">保存食は、主に水気の無い乾物を揃えたもので、長旅に向いた携行食だ。これには堅パンや干し肉、干し果物、ナッツなどが含まれる。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="17" value="5" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ヘンプロープ（50フィート）<span class="tip-body">ロープはHP2。引きちぎる場合、難易度17【筋力】判定を要する。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="18" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">水袋<span class="tip-body">4パイント液体を入れることができる。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="19" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">携帯用炊事用具<span class="tip-body">錫でできた入れ物の中には、1つのコップ、ナイフ、フォーク、スプーンなどが入っている。さらに入れ物自体が2つに分かれ、一方は平鍋、もう一方は皿として使用できる。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="20" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">羊皮紙<span class="tip-body">重めの羊皮紙が1枚。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="21" value="25" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ペン<span class="tip-body">インクと共に使用し、紙に書き込みまたは描画するための道具。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="22" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ずだ袋<span class="tip-body">1立方フィート / 300ポンドの物を入れることができる。</span></span></td><td class="text-s text-m">container</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="23" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class=" eq-toggle" style="color:var(--grn)" data-action="toggle-equip" data-item-idx="24">◆</span> <span class="tip" tabindex="0">普通の服<span class="tip-body">ほとんどの一般人が着る服。</span></span></td><td class="text-s text-m">equipment</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="24" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">治療用具<span class="tip-body">革製のポーチに包帯や軟膏、添え木などが詰まったもの。君は1回のアクションとして治療用具の使用回数を1回分使用し、HP0のクリーチャー1体を容態安定化することができる。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="28" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class=" eq-toggle" style="color:var(--grn)" data-action="toggle-equip" data-item-idx="29">◆</span> <span class="tip" tabindex="0">アミュレット・オヴ・ヘルス<span class="tip-body">その他の魔法のアイテム（要同調）
このアミュレットを着用している間、君の【耐久力】値は19になる。【耐久力】がもともと19以上だった場合は何の効果もない。</span></span></td><td class="text-s text-m">equipment</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="29" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class=" eq-toggle" style="color:var(--grn)" data-action="toggle-equip" data-item-idx="30">◆</span> <span class="tip" tabindex="0">リング・オヴ・プロテクション／守りの指輪<span class="tip-body">（要同調）
&nbsp;この指輪を着用している間、君はACとすべてのセーヴィング・スローに+1のボーナスを得る。</span></span></td><td class="text-s text-m">equipment</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="30" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">保存食<span class="tip-body">保存食は、主に水気の無い乾物を揃えたもので、長旅に向いた携行食だ。これには堅パンや干し肉、干し果物、ナッツなどが含まれる。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="31" value="8" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">インク（1オンス入りのビン）<span class="tip-body">羊皮紙に書くために使うインクの小さなボトル。</span></span></td><td class="text-s text-m">loot</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="38" value="22" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ヘンプロープ（50フィート）<span class="tip-body">ロープはHP2。引きちぎる場合、難易度17【筋力】判定を要する。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="39" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ヘンプロープ（50フィート）<span class="tip-body">ロープはHP2。引きちぎる場合、難易度17【筋力】判定を要する。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="40" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ポーション・オヴ・ヒーリング／癒しの水薬<span class="tip-body">ポーションの赤い液体をゆらすと、ほのかな光輝を放つ。
このポーションを飲むことで、2d4 + 2ヒットポイントが回復する。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="44" value="3" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">ポーション・オヴ・グレーター・ヒーリング<span class="tip-body">ポーションの赤い液体をゆらすと、ほのかな光輝を放つ。
このポーションを飲むことで、4d4 + 4ヒットポイントが回復する。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="45" value="1" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr><tr><td><span class="tip" tabindex="0">油 (ビン)<span class="tip-body">1パイント(約500cc)の油が入った陶器製のビン。君は1回のアクションとして、5フィート以内のクリーチャーに中の油を浴びせるか、20フィートまで投擲することができる(衝撃で割れる)。どちらの場合も、油ビンを代用武器として扱い、1回の遠隔攻撃として判定する。
命中したら対象は油で覆われる。油は1分後に乾くが、それまでに[火]ダメージを与えたなら、追加で5[火]ダメージを与えることができる。
あるいは、君は1回のアクションとして平らな地面に油をまき、5×5フィートの範囲を油で覆うことができる。
これに火が付いたなら2ラウンド燃え続け、その範囲に入ったクリーチャーに5[火]ダメージを与えることができる。1体のクリーチャーが、1ターンに2回以上、このダメージを受けることは無い。</span></span></td><td class="text-s text-m">consumable</td><td><span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" data-action="set-quantity" data-item-idx="46" value="2" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></td></tr></tbody></table><div class="coins"><span class="coin coin-pp"><span class="cl">PP</span> <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-coin" data-action="set-currency" data-coin="pp" value="0" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></span><span class="coin coin-gp"><span class="cl">GP</span> <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-coin" data-action="set-currency" data-coin="gp" value="71" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></span><span class="coin coin-ep"><span class="cl">EP</span> <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-coin" data-action="set-currency" data-coin="ep" value="0" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></span><span class="coin coin-sp"><span class="cl">SP</span> <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-coin" data-action="set-currency" data-coin="sp" value="49" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></span><span class="coin coin-cp"><span class="cl">CP</span> <span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-coin" data-action="set-currency" data-coin="cp" value="11" min="0"><button type="button" class="nc-btn" data-nc="1">+</button></span></span></div></div></div></div><div class="pers-grid"><div class="pers-box"><div class="lbl">性格特徴</div><div class="ct"><p><span style="font-family: &#39;Noto Sans JP&#39;">一度嫌いになった相手は絶対に許さない<br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">敬愛する姉とその子らを愚弄したり気づ付けた者は許さない。絶対にだ。じわじわとなぶり殺しにしてやる！</span></p></div></div><div class="pers-box"><div class="lbl">理想</div><div class="ct"><p><span style="font-family: &#39;Noto Sans JP&#39;">血は水よりも濃い<br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">姉と自分の家族は世界で最も大事。だって家族だもん………弟の家族？あれは他人。</span></p></div></div><div class="pers-box"><div class="lbl">絆</div><div class="ct"><p><span style="font-family: &#39;Noto Sans JP&#39;">家族からの賞賛を受ける為なら、どんな挑戦にも立ち向かう<br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">姉と自分の家族の為、そして家族から尊敬のまなざしを受ける為なら、火の中に飛び込むし国の王だってぶん殴ってみせる。</span></p></div></div><div class="pers-box"><div class="lbl">弱点</div><div class="ct"><p><span style="font-family: &#39;Noto Sans JP&#39;">しばしば言葉や行為により一族に恥辱をもたらす<br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;"><br style="color: rgb(0, 0, 0); font-family: &#39;Noto Sans JP&#39;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">氏族の者どもは地質学や植物学への理解が薄すぎる（採掘した標本石を舐めながら）</span></p></div></div></div><div class="sec"><div class="sec-title">習熟・言語</div><div class="pl-grid"><div class="pl-grp"><div class="lbl">言語</div><div class="items"><span class="pill">common</span><span class="pill">elvish</span><span class="pill">infernal</span><span class="pill">orc</span></div></div><div class="pl-grp"><div class="lbl">武器習熟</div><div class="items"><span class="pill">sim</span><span class="pill">mar</span></div></div><div class="pl-grp"><div class="lbl">防具習熟</div><div class="items"><span class="pill">lgt</span><span class="pill">med</span><span class="pill">shl</span></div></div></div></div><div class="sec"><div class="sec-title">特徴・特技</div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">フェイの血筋<span class="tip-body">君は魅了状態をもたらす効果に対するセーヴィング・スローに有利を得る。また、魔法は君を眠らせることはできない。</span></span></span><span class="fs">エルフ, ハーフエルフ</span><div class="fd">君は魅了状態をもたらす効果に対するセーヴィング・スローに有利を得る。また、魔法は君を眠らせることはできない。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">激怒<span class="tip-body">君は戦場にあっては原始の檸猛さをもって戦う。君は自分のターンに1回のボーナス・アクションとして“激怒”に入ることができる。激怒中、君は重装鎧を着用していない限り以下の利益を得る。


【筋力】判定と【筋力】セーヴィング・スローに有利を得る。


【筋力】を用いて近接武器攻撃を行なう際、ダメージ・ロールにボーナスを得る。ボーナスの値はバーバリアンのレベルが上昇するにつれて増加する。『バーバリアン』表の激怒時ダメージの欄を参照。


[殴打]、[刺突]、[斬撃]ダメージに対する抵抗を得る。


君は、もし呪文発動が可能であっても、激怒中は呪文発動も呪文に対する精神集中も不可能になる。
激怒は1分間持続する。君が気絶状態になるか、あるいは君が、前の君のターンの終了時からずっと、ダメージを受けることも敵対的なクリーチャーを攻撃することもないまま、ターンを終了したなら、その時は(まだ1分間経っていなくても)激怒は終了する。
また、君は自分のターンに1回のボーナス・アクションとして激怒を終了させることもできる。『バーバリアン』表にある回数だけ激怒したなら、以後君は大休憩を終了するまでは再び激怒できない。
注意：使用回数は1に設定されていますが、取得後に適切な数に設定し直してください。



レベル
激怒
激怒ダメージ


1
2
+2


2
2
+2


3
3
+2


4
3
+2


5
3
+2


6
4
+2


7
4
+2


8
4
+2


9
4
+3


10
4
+3


11
4
+3


12
5
+3


13
5
+3


14
5
+3


15
5
+3


16
5
+4


17
6
+4


18
6
+4


19
6
+4


20
無限回
+4</span></span></span><span class="feat-uses">(<span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" style="width:32px" data-action="set-uses" data-item-idx="3" value="0" min="0" max="@scale.barbarian.rages"><button type="button" class="nc-btn" data-nc="1">+</button></span> / @scale.barbarian.rages)</span><span class="fs">バーバリアン 1</span><div class="fd">君は戦場にあっては原始の檸猛さをもって戦う。君は自分のターンに1回のボーナス・アクションとして“激怒”に入ることができる。激怒中、君は重装鎧を着用していない限り以下の利益を得る。


【筋力】判定と【筋力】セーヴィング・スローに有利を得る。


【筋力】を用いて近接武器攻撃を行なう際、ダメージ・ロールにボーナスを得る。ボーナスの値はバーバリアンのレベルが上昇するにつれて増加する。『バーバリアン』表の激怒時ダメージの欄を参照。


[殴打]、[刺突]、[斬撃]ダメージに対する抵抗を得る。


君は…</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">鎧わぬ守り（バーバリアン）<span class="tip-body">1レベルの時点で君は、いかなる鎧も着用していない時、君のアーマー・クラスは(10+君の【敏捷力】修正値+君の【耐久力】修正値)に等しくなる。盾を使用していてもこの利益は問題なく得られる。</span></span></span><span class="fs">バーバリアン 1</span><div class="fd">1レベルの時点で君は、いかなる鎧も着用していない時、君のアーマー・クラスは(10+君の【敏捷力】修正値+君の【耐久力】修正値)に等しくなる。盾を使用していてもこの利益は問題なく得られる。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">従者<span class="tip-body">君は高貴な生れであるため、人々は君に最上級のもてなしをするべきだと考える。君は上流社会で歓迎され、人々は君がどこにいようとも無礼だとは思わない。平民たちはあらゆる手を尽くして君を歓待し、不興を買うのを避けようとする。他の高貴な生まれの人々は、君を同じ社会階級の一員として扱う。必要があれば、君は土地の貴族に謁見を求めることができる。</span></span></span><span class="fs">貴族または騎士</span><div class="fd">君は高貴な生れであるため、人々は君に最上級のもてなしをするべきだと考える。君は上流社会で歓迎され、人々は君がどこにいようとも無礼だとは思わない。平民たちはあらゆる手を尽くして君を歓待し、不興を買うのを避けようとする。他の高貴な生まれの人々は、君を同じ社会階級の一員として扱う。必要があれば、君は土地の貴族に謁見を求めることができる。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">捨て身の攻撃<span class="tip-body">レベル2の時点で君は、防御をかなぐり捨てて捨て身の攻撃を打ちこむことが可能になる。
君は自分のターンに最初の攻撃を行なう際、“捨て身の攻撃”を宣言できる。そうすれば、君はそのターンにおいて【筋力】を用いる近接武器攻撃ロールに有利を得るかわり、君の次のターンの開始時まで君に対する攻撃ロールにも有利が付く。</span></span></span><span class="fs">バーバリアン 2</span><div class="fd">レベル2の時点で君は、防御をかなぐり捨てて捨て身の攻撃を打ちこむことが可能になる。
君は自分のターンに最初の攻撃を行なう際、“捨て身の攻撃”を宣言できる。そうすれば、君はそのターンにおいて【筋力】を用いる近接武器攻撃ロールに有利を得るかわり、君の次のターンの開始時まで君に対する攻撃ロールにも有利が付く。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">危険感知<span class="tip-body">2レベルの時点で、君は危険を上手にかわすことができるようになる。君は罠や呪文のような自分から見える効果に対する【敏捷力】セーヴィング・スローに有利を得る。この利益を得られるのは、盲目状態でも聴覚喪失状態でも無力状態でもない時のみである。</span></span></span><span class="fs">バーバリアン 2</span><div class="fd">2レベルの時点で、君は危険を上手にかわすことができるようになる。君は罠や呪文のような自分から見える効果に対する【敏捷力】セーヴィング・スローに有利を得る。この利益を得られるのは、盲目状態でも聴覚喪失状態でも無力状態でもない時のみである。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">原始の道<span class="tip-body">3レベルの時点で君は@Compendium[dnd5e.subclasses.uGuDQX9Mz3oHNHkU]{狂戦士の道}などの1つの道を選ぶ。その道が君の激怒の性質を左右する。3、6、10、14レベルで得られる特徴が決定される。</span></span></span><span class="fs">バーバリアン 3</span><div class="fd">3レベルの時点で君は@Compendium[dnd5e.subclasses.uGuDQX9Mz3oHNHkU]{狂戦士の道}などの1つの道を選ぶ。その道が君の激怒の性質を左右する。3、6、10、14レベルで得られる特徴が決定される。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">魔法知覚<span class="tip-body">君は1回のアクションとして心の目を開くことで、凝縮された魔力の存在を感じ取れるようになる。君の次のターンの終了時まで、君は60フィート以内に存在するあらゆる呪文および魔法のアイテムの位置が分かる（完全遮蔽の背後にあるものを除く）。このようにして呪文を感知した際には、その魔法の系統も分かる。　君はこの特徴を、君の習熟ボーナスに等しい回数だけ使用できる。君が大休憩を終えるたび、消費した使用回数はすべて回復する。</span></span></span><span class="feat-uses">(<span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="e-num" style="width:32px" data-action="set-uses" data-item-idx="34" value="0" min="0" max="@prof"><button type="button" class="nc-btn" data-nc="1">+</button></span> / @prof)</span><span class="fs">荒ぶる魔力の道 Lv3</span><div class="fd">君は1回のアクションとして心の目を開くことで、凝縮された魔力の存在を感じ取れるようになる。君の次のターンの終了時まで、君は60フィート以内に存在するあらゆる呪文および魔法のアイテムの位置が分かる（完全遮蔽の背後にあるものを除く）。このようにして呪文を感知した際には、その魔法の系統も分かる。　君はこの特徴を、君の習熟ボーナスに等しい回数だけ使用できる。君が大休憩を終えるたび、消費した使用回数はすべて回復する。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">荒ぶる魔力の奔流<span class="tip-body">君の内で荒れ狂う魔法のエネルギーは、時おり君から溢れ出す。君が@Compendium[completecompendium.classfeatures-PHB.激怒]に入るとき、『荒ぶる魔力』表をロールして、どのような魔法的効果が発生するかを決めること。　発生した効果がセーヴィング・スローを要求する場合、そのセーヴ難易度は（8+君の習熟ボーナス+君の【耐久力】修正値）である。荒ぶる魔力[[/r 1d8]]魔力の効果@Compendium[tasha-compendium.classfeatures.影の触手(荒ぶる魔力)]{1}影の触手が君の周囲を打ち据える。君の30フィート以内にいて君から見えるクリーチャーを任意の数だけ選ぶこと。それらのクリーチャーは【耐久力】セーヴに失敗すると[[/r 1d12]][死霊]ダメージを受ける。また、君は[[/r 1d12]]の一時的hpを得る。@Compendium[tasha-compendium.classfeatures.瞬間移動(荒ぶる魔力)]{2}君は自分が見ることのできる30フィート以内の何ものにも占められていない場所へ瞬間移動する。君は@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、自分の各ターンにボーナス・アクションとして再びこの効果を使用できる。@Compendium[tasha-compendium.classfeatures.精霊(荒ぶる魔力)]{3}君の30フィート以内にいて君から見えるクリーチャー1体の5フィート以内に、@Compendium[completecompendium.creaturesjp.フランフ]または@Compendium[completecompendium.creaturesjp.ピクシー]（どちらかを君が選ぶ）に似た外見の実態なき精霊が1つ現れる。その精霊はこのターンの終了時に爆発し、精霊の5フィート以内にいるクリーチャーはみな【敏捷力】セーヴに失敗すると[[/r 1d6]][力場]ダメージを受ける。君は@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、自分の各ターンにボーナス・アクションとして再びこの効果を使用でき、それによって精霊を再召喚できる。4君が手に持っている武器1つを選ぶ。その武器に魔力が満ちる。君の@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、この武器のダメージ種別は[力場]に変わり、“軽武器”と“投擲”（通常射程20フィート、長距離射程60フィート）の特性が付く。この武器が君の手から離れた場合、そのターンの終了時に君の手の中に再出現する。@Compendium[tasha-compendium.classfeatures.報復(荒ぶる魔力)]{5}君の@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、君に攻撃ロールでヒットを与えたクリーチャーは魔力の報復を被り、1回のヒットにつき[[/r 1d6]][力場]ダメージを受ける。@Compendium[tasha-compendium.classfeatures.守り(荒ぶる魔力)]{6}君は@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、極彩色の守りの光に包まれる。この間、君はACに+1ボーナスを得る。君の味方も、君から10フィート以内にいる間は同じボーナスを得る。7君の周囲に花と蔦が一時的に生い茂る。君の@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、君から15フィート以内の地面は君の敵となって移動困難な地形である。@Compendium[tasha-compendium.classfeatures.光(荒ぶる魔力)]{8}君は胸元から一条の光を放つ。君の30フィート以内にいて君から見える、君以外のクリーチャー1体を選ぶこと。そのクリーチャーは【耐久力】セーヴを行なわねばならず、失敗すると[[/r 1d6]][光輝]ダメージを受けた上に君の次のターンの開始時まで@Compendium[completecompendium.betterconditions.盲目状態]になる。君は@Compendium[completecompendium.classfeatures-PHB.激怒]が終了するまで、自分の各ターンにボーナス・アクションとして再びこの効果を使用できる。</span></span></span><span class="fs">荒ぶる魔力の道 Lv3</span><div class="fd">君の内で荒れ狂う魔法のエネルギーは、時おり君から溢れ出す。君が@Compendium[completecompendium.classfeatures-PHB.激怒]に入るとき、『荒ぶる魔力』表をロールして、どのような魔法的効果が発生するかを決めること。　発生した効果がセーヴィング・スローを要求する場合、そのセーヴ難易度は（8+君の習熟ボーナス+君の【耐久力】修正値）である。荒ぶる魔力[[/r 1d8]]魔力の効果@Compendium[tasha-compendium.classfeature…</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">追加攻撃<span class="tip-body">君は自分のターンに攻撃アクションをとるたびに1回ではなく2回攻撃を行なえるようになる。</span></span></span><span class="fs">バーバリアン 5, モンク 5, パラディン 5, レンジャー 5</span><div class="fd">君は自分のターンに攻撃アクションをとるたびに1回ではなく2回攻撃を行なえるようになる。</div></div><div class="feat-item"><span class="fn"><span class="tip" tabindex="0">高速移動<span class="tip-body">5レベル以降、君の移動速度は、重装鎧を着用していない限り10フィート増加する。</span></span></span><span class="fs">バーバリアン 5</span><div class="fd">5レベル以降、君の移動速度は、重装鎧を着用していない限り10フィート増加する。</div></div></div><div class="sec"><div class="sec-title">経歴・外見</div><div class="bio-ct"><p><span style="font-family:&#39;Noto Sans JP&#39;">ラッパンアスクの南西にある、クレティア山脈周辺のバーバリアン氏族出身のハーフエルフ。重度のシスコン。<br style="color:rgb(0, 0, 0);font-family:&#39;Noto Sans JP&#39;;font-size:12px;font-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;white-space:normal;text-decoration-thickness:initial;text-decoration-style:initial;text-decoration-color:initial">父がハーフエルフのウィザード、母が氏族長親族の娘で、ヒューマンの姉（パウラ、美人で賢い）と弟（エーリク、短慮で酒乱）がいた。<br style="color:rgb(0, 0, 0);font-family:&#39;Noto Sans JP&#39;;font-size:12px;font-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;white-space:normal;text-decoration-thickness:initial;text-decoration-style:initial;text-decoration-color:initial">ハーフエルフに生まれた為、族長の位は姉の息子（アンセル：長男）が継承いた。<br style="color:rgb(0, 0, 0);font-family:&#39;Noto Sans JP&#39;;font-size:12px;font-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;white-space:normal;text-decoration-thickness:initial;text-decoration-style:initial;text-decoration-color:initial">普段は、父に教えを受け身に着けた様々な知識を周辺氏族に授ける知恵者にして戦の際には軍師として、姉と自分の家族に尽くす以外は氏族から離れ一人で暮らしていたが、近年パウラの来孫にあたる娘（マリカ）が族長位を継承しようとしたところ、弟の夜叉孫（トルヴァン）から「マリカの曽祖父（サロモン：アンセルの四男）が氏族の魔剣を持って出奔し、100年の間魔剣が失わている。そのような者の子孫を族長とする事は出来ない」と批判され族長位を継承出来なくなってしまった。<br style="color:rgb(0, 0, 0);font-family:&#39;Noto Sans JP&#39;;font-size:12px;font-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:normal;orphans:2;text-align:start;text-indent:0px;text-transform:none;widows:2;word-spacing:0px;-webkit-text-stroke-width:0px;white-space:normal;text-decoration-thickness:initial;text-decoration-style:initial;text-decoration-color:initial">愛する姉の子孫を助ける為、ヴィッケは魔剣を取り戻す旅へと出た。</span></p></div></div></div>
<footer class="site-footer">Copyright © 2026, Kendermore Convention &amp; Visitors Bureau Office. Licensed under the <span class="mit-tip" tabindex="0">MIT License<span class="mit-body">MIT License

Copyright (c) 2026 Kendermore Convention &amp; Visitors Bureau Office

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span></span>.</footer>

<script>
const $=s=>document.querySelector(s);
const ABILS={str:'筋力',dex:'敏捷',con:'耐久',int:'知力',wis:'判断',cha:'魅力'};
const SKILL_MAP={
  acr:['軽業','dex'],ani:['動物使い','wis'],arc:['魔法学','int'],ath:['運動','str'],
  dec:['ペテン','cha'],his:['歴史','int'],ins:['看破','wis'],itm:['威圧','cha'],
  inv:['捜査','int'],med:['医術','wis'],nat:['自然','int'],prc:['知覚','wis'],
  prf:['芸能','cha'],per:['説得','cha'],rel:['宗教','int'],slt:['手先の早業','dex'],
  ste:['隠密','dex'],sur:['生存','wis']
};
const SCHOOLS={abj:'防御',con:'召喚',div:'占術',enc:'心術',evo:'力術',ill:'幻術',nec:'死霊',trs:'変成'};

function mod(s){return Math.floor(((s??10)-10)/2)}
function fm(m){return m>=0?'+'+m:''+m}
function tx(html){if(!html)return '';const d=document.createElement('div');d.innerHTML=html;return d.textContent.trim()}
function dotCls(p){return p>=2?'expert':p>=1?'full':p>0?'half':''}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function tip(name,descHtml){
  const desc=tx(descHtml);
  if(!desc) return name;
  const safe=desc.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;');
  return `<span class="tip" tabindex="0">${name}<span class="tip-body">${safe}</span></span>`;
}
function nc(cls,attrs,val,min,max){
  const mn=min!=null?` min="${min}"`:'';
  const mx=max!=null?` max="${max}"`:'';
  return `<span class="nc"><button type="button" class="nc-btn" data-nc="-1">−</button><input type="number" class="${cls}" ${attrs} value="${val}"${mn}${mx}><button type="button" class="nc-btn" data-nc="1">+</button></span>`;
}

// --- Data ---
let currentActor=null;
let currentActors=[];
let dirty=false;

function ensurePath(obj,...keys){
  let c=obj;
  for(const k of keys){if(!c[k])c[k]={};c=c[k];}
  return c;
}

function pickActors(json){
  if(Array.isArray(json)) return json.filter(a=>a?.type==='character'||a?.type==='npc'||a?.system?.abilities);
  if(json?.actors) return json.actors.filter(a=>a?.type==='character'||a?.system?.abilities);
  if(json?.type&&json?.system) return [json];
  return [];
}

function getLevel(actor){
  const items=actor.items||[];
  const cls=items.filter(i=>i.type==='class');
  if(cls.length>0) return cls.reduce((s,c)=>s+(c.system?.levels||0),0);
  const sys=actor.system||{};
  return sys.details?.level??sys.details?.levels??0;
}

function getClasses(items){
  const cls=items.filter(i=>i.type==='class');
  if(!cls.length) return '—';
  return cls.map(c=>{
    const sub=items.find(i=>i.type==='subclass'&&(i.system?.classIdentifier===c.system?.identifier||i.system?.parentClass===c._id));
    return c.name+(sub?' ('+sub.name+')':'');
  }).join(' / ');
}

function getRace(actor){
  const raceItem=(actor.items||[]).find(i=>i.type==='race');
  if(raceItem) return raceItem.name;
  const r=actor.system?.details?.race;
  return (typeof r==='string')?r:'';
}

function getBackground(actor){
  const bgItem=(actor.items||[]).find(i=>i.type==='background');
  if(bgItem) return bgItem.name;
  const r=actor.system?.details?.background;
  return (typeof r==='string')?r:'';
}

function getAC(sys,items){
  if(typeof sys.attributes?.ac?.value==='number') return sys.attributes.ac.value;
  if(typeof sys.attributes?.ac?.flat==='number') return sys.attributes.ac.flat;
  if(typeof sys.attributes?.ac==='number') return sys.attributes.ac;
  const dexMod=mod(sys.abilities?.dex?.value);
  const calc=sys.attributes?.ac?.calc||'default';
  const armors=(items||[]).filter(i=>(i.type==='equipment'||i.type==='armor')&&i.system?.equipped&&i.system?.armor?.value);
  if(armors.length){
    let best=10;
    for(const a of armors){
      const av=a.system.armor.value;
      const at=a.system?.type?.value||a.system?.armor?.type||'light';
      if(at==='heavy') best=Math.max(best,av);
      else if(at==='medium') best=Math.max(best,av+Math.min(dexMod,2));
      else if(at==='shield') best+=2;
      else best=Math.max(best,av+dexMod);
    }
    return best;
  }
  if(calc==='mage') return 13+dexMod;
  if(calc==='natural') return 10+dexMod;
  return 10+dexMod;
}

function getAbilMod(sys,abil){
  const a=sys.abilities?.[abil]||{};
  return typeof a.mod==='number'?a.mod:mod(a.value);
}

function weaponDmg(ws,sys,prof){
  const acts=ws.activities?Object.values(ws.activities):[];
  const atk=acts.find(a=>a.type==='attack'||a.type==='damage');
  if(atk){
    let ability=atk.attack?.ability||ws.ability||'';
    const atkType=atk.attack?.type?.value||'melee';
    let abilMod;
    if(ability==='spellcasting'){
      ability=sys.attributes?.spellcasting||'int';
      abilMod=getAbilMod(sys,ability);
    }else if(ability&&sys.abilities?.[ability]){
      abilMod=getAbilMod(sys,ability);
    }else{
      const props=Array.isArray(ws.properties)?ws.properties:(ws.properties?.value||[]);
      const fin=Array.isArray(props)?props.includes('fin'):false;
      if(atkType==='ranged') abilMod=getAbilMod(sys,'dex');
      else if(fin) abilMod=Math.max(getAbilMod(sys,'str'),getAbilMod(sys,'dex'));
      else abilMod=getAbilMod(sys,'str');
    }
    const mag=ws.magicalBonus||0;
    const ab=parseInt(atk.attack?.bonus)||0;
    const pr=ws.proficient!==false?(sys.attributes?.prof??prof??2):0;
    const atkTotal=abilMod+pr+mag+ab;
    const parts=atk.damage?.parts||[];
    let dmg=parts.map(p=>{
      if(Array.isArray(p)) return p.join(' ');
      let d='';
      if(p.number&&p.denomination) d=p.number+'d'+p.denomination;
      if(p.bonus) d+=(String(p.bonus).startsWith('+')||String(p.bonus).startsWith('-')?'':'+')+p.bonus;
      const types=(p.types||[]).filter(t=>t&&t!=='none');
      return [d,types.join('/')].filter(Boolean).join(' ');
    }).join(' + ')||'—';
    if(dmg!=='—'&&abilMod) dmg+=' '+fm(abilMod);
    if(mag>0) dmg+=' +'+mag;
    return {atk:fm(atkTotal),dmg};
  }
  const ability=ws.ability||'str';
  const abilMod=getAbilMod(sys,ability);
  const pr2=ws.proficient!==false?(sys.attributes?.prof??prof??2):0;
  const atkB=abilMod+pr2+(ws.attackBonus||0);
  const parts=(ws.damage?.parts||[]).map(p=>Array.isArray(p)?p.join(' '):String(p)).join(' / ');
  return {atk:fm(atkB),dmg:parts||'—'};
}

// --- Save details open state ---
function saveDetailsState(){
  const state={};
  document.querySelectorAll('#sheet details').forEach((d,i)=>{state[i]=d.open;});
  return state;
}
function restoreDetailsState(state){
  document.querySelectorAll('#sheet details').forEach((d,i)=>{if(i in state)d.open=state[i];});
}

// --- Render ---
function render(actor){
  if(!actor){$('#sheet').innerHTML='<p class="text-m">キャラが見つかりません</p>';return;}
  currentActor=actor;

  const detState=saveDetailsState();
  const scrollY=window.scrollY;

  const sys=actor.system||{};
  const items=actor.items||[];
  const level=getLevel(actor);
  const prof=sys.attributes?.prof??Math.floor(Math.max(level-1,0)/4)+2;
  let h='';

  // Header
  const name=actor.name||'(unnamed)';
  const cls=getClasses(items);
  const race=getRace(actor);
  const bg=getBackground(actor);
  const align=sys.details?.alignment||'';
  const xp=sys.details?.xp?.value;
  h+=`<div class="char-header"><div class="char-name">${name}</div><div class="char-sub">${cls} Lv${level||'?'} · ${race||'—'} · ${bg||'—'} · ${align||'—'}${xp!=null?' · '+xp+' XP':''}</div></div>`;

  h+='<div class="sheet-body">';

  // Col1: Abilities
  h+='<div class="ab-col">';
  for(const[k,label] of Object.entries(ABILS)){
    const a=sys.abilities?.[k]||{};
    const sc=a.value??10;
    const m=typeof a.mod==='number'?a.mod:mod(sc);
    h+=`<div class="ab-box"><div class="ab-lbl">${k.toUpperCase()}</div><div class="ab-score">${sc}</div><div class="ab-mod">${fm(m)}</div></div>`;
  }
  h+='</div>';

  // Col2: Saves & Skills
  h+='<div>';

  // Inspiration & Prof
  const insp=sys.attributes?.inspiration;
  h+=`<div class="prof-row"><div class="prof-box"><div class="big clickable" data-action="toggle-inspiration">${insp?'★':'☆'}</div><div class="lbl">Inspiration</div></div><div class="prof-box"><div class="big">+${prof}</div><div class="lbl">習熟ボーナス</div></div></div>`;

  // Saves
  h+='<div class="panel"><div class="p-title">セーヴィング・スロー</div>';
  for(const[k,label] of Object.entries(ABILS)){
    const a=sys.abilities?.[k]||{};
    const m=getAbilMod(sys,k);
    const p=a.proficient?true:false;
    const total=p?m+prof:m;
    h+=`<div class="s-row"><div class="dot ${p?'full':''}"></div><div class="bonus">${fm(total)}</div><div class="name">${label}</div></div>`;
  }
  h+='</div>';

  // Skills
  h+='<div class="panel"><div class="p-title">技能</div>';
  for(const[k,[label,defAbil]] of Object.entries(SKILL_MAP)){
    const sk=sys.skills?.[k]||{};
    const abil=sk.ability||defAbil;
    const abilMod=getAbilMod(sys,abil);
    const pl=sk.value??sk.prof??0;
    const total=abilMod+(pl?Math.round(prof*pl):0);
    h+=`<div class="s-row"><div class="dot ${dotCls(pl)}"></div><div class="bonus">${fm(total)}</div><div class="name">${label}<span class="abil">${abil}</span></div></div>`;
  }
  h+='</div>';

  // Passive Perception
  const prc=sys.skills?.prc||{};
  const prcAbil=prc.ability||'wis';
  const prcMod=getAbilMod(sys,prcAbil);
  const prcPl=prc.value??prc.prof??0;
  const passiveP=10+prcMod+(prcPl?Math.round(prof*prcPl):0);
  h+=`<div class="passive"><div class="big">${passiveP}</div><div class="lbl">受動知覚 (Passive Perception)</div></div>`;
  h+='</div>';

  // Col3: Combat
  h+='<div>';

  // AC, Init, Speed
  const ac=getAC(sys,items);
  const init=getAbilMod(sys,'dex')+(parseInt(sys.attributes?.init?.bonus)||0);
  const spd=sys.attributes?.movement?.walk??sys.attributes?.speed?.value??30;
  h+=`<div class="combat-trio"><div class="c-box"><div class="lbl">AC</div><div class="val">${ac}</div></div><div class="c-box"><div class="lbl">イニシアチブ</div><div class="val">${fm(init)}</div></div><div class="c-box"><div class="lbl">移動速度</div><div class="val">${spd}</div><div class="unit">ft</div></div></div>`;

  // HP
  const hp=ensurePath(sys,'attributes','hp');
  const hpCur=hp.value??0;
  const hpMax=hp.max??hpCur;
  const hpTemp=hp.temp??0;
  const hpR=hpMax>0?hpCur/hpMax:1;
  const hpC=hpR>.5?'var(--grn)':hpR>.25?'#c8a030':'var(--red)';
  h+=`<div class="hp-panel"><div class="p-title">ヒットポイント</div>`;
  h+=`<div class="hp-row">${nc('hp-cur','data-action="set-hp"',hpCur,0,hpMax)}<span class="hp-sep">/</span><span class="hp-max">${hpMax}</span></div>`;
  h+=`<div class="hp-bar"><div class="hp-bar-fill" style="width:${Math.round(hpR*100)}%;background:${hpC}"></div></div>`;
  h+=`<div class="hp-adj"><button class="hp-btn hp-btn-dmg" data-action="hp-dmg">Damage</button>${nc('hp-adj-input','id="hpDelta"',0,0,null)}<button class="hp-btn hp-btn-heal" data-action="hp-heal">Heal</button></div>`;
  h+=`<div class="hp-temp-row">一時HP: ${nc('hp-temp-input','data-action="set-temp-hp"',hpTemp,0,null)}</div>`;
  h+=`</div>`;

  // Hit Dice & Death Saves
  const clsItems=items.filter(i=>i.type==='class');
  h+=`<div class="hd-death">`;
  // Hit Dice
  h+=`<div class="mini-p"><div class="lbl">ヒットダイス</div>`;
  if(clsItems.length){
    for(let ci=0;ci<clsItems.length;ci++){
      const c=clsItems[ci];
      const hd=c.system?.hd||{};
      const den=hd.denomination||'d8';
      const lvl=c.system?.levels||0;
      const spent=hd.spent||0;
      const remain=lvl-spent;
      h+=`<div style="margin:3px 0"><span class="text-s">${den}</span> <span style="font-weight:700">${remain}</span>/${lvl} `;
      h+=`<button class="hp-btn hp-btn-dmg" style="font-size:10px;padding:1px 6px" data-action="hd-use" data-class-idx="${ci}">使用</button> `;
      h+=`<button class="hp-btn hp-btn-heal" style="font-size:10px;padding:1px 6px" data-action="hd-recover" data-class-idx="${ci}">回復</button>`;
      h+=`</div>`;
    }
  }else h+='<div>—</div>';
  h+=`</div>`;
  // Death Saves
  const death=ensurePath(sys,'attributes','death');
  const dS=death.success||0,dF=death.failure||0;
  h+=`<div class="mini-p"><div class="lbl">デス・セーヴ</div>`;
  h+=`<div class="text-s">成功</div><div class="dd">${[0,1,2].map(i=>`<div class="d ${i<dS?'ok':''}" data-action="death-success" data-idx="${i}"></div>`).join('')}</div>`;
  h+=`<div class="text-s">失敗</div><div class="dd">${[0,1,2].map(i=>`<div class="d ${i<dF?'ng':''}" data-action="death-failure" data-idx="${i}"></div>`).join('')}</div>`;
  h+=`</div></div>`;

  // Attacks
  const weapons=items.filter(i=>i.type==='weapon');
  h+='<div class="panel"><div class="p-title">攻撃</div>';
  if(weapons.length){
    h+='<table class="t"><thead><tr><th>名称</th><th>攻撃</th><th>ダメージ</th></tr></thead><tbody>';
    for(const w of weapons){
      const r=weaponDmg(w.system||{},sys,prof);
      h+=`<tr><td>${tip(w.name,w.system?.description?.value)}</td><td>${r.atk}</td><td>${r.dmg}</td></tr>`;
    }
    h+='</tbody></table>';
  }else h+='<div class="text-m text-s">—</div>';
  h+='</div>';

  // Equipment
  const eqTypes=new Set(['equipment','consumable','tool','loot','backpack','armor','container']);
  const eqItems=items.filter(i=>eqTypes.has(i.type));
  if(eqItems.length){
    h+='<div class="panel"><div class="p-title">装備・所持品</div><table class="t"><thead><tr><th>名称</th><th>種別</th><th>数</th></tr></thead><tbody>';
    for(const it of eqItems){
      const s=it.system||{};
      const idx=items.indexOf(it);
      const hasEquip=(it.type==='equipment'||it.type==='armor');
      const eqIcon=hasEquip?(s.equipped?'◆':'◇'):'';
      const eqAttr=hasEquip?` data-action="toggle-equip" data-item-idx="${idx}"`:'';
      const eqCls=hasEquip?' eq-toggle':'';
      const eqColor=s.equipped?'color:var(--grn)':'color:var(--td)';
      h+=`<tr><td>${hasEquip?`<span class="${eqCls}" style="${eqColor}"${eqAttr}>${eqIcon}</span> `:''}${tip(it.name,s.description?.value)}</td><td class="text-s text-m">${it.type}</td><td>${nc('e-num',`data-action="set-quantity" data-item-idx="${idx}"`,s.quantity??1,0,null)}</td></tr>`;
    }
    h+='</tbody></table>';
    // Currency
    const cur=ensurePath(sys,'currency');
    h+=`<div class="coins">`;
    for(const[k,label] of [['pp','PP'],['gp','GP'],['ep','EP'],['sp','SP'],['cp','CP']]){
      h+=`<span class="coin coin-${k}"><span class="cl">${label}</span> ${nc('e-coin',`data-action="set-currency" data-coin="${k}"`,cur[k]||0,0,null)}</span>`;
    }
    h+=`</div></div>`;
  }

  // Senses
  const senses=sys.attributes?.senses||{};
  const sl=[];
  if(senses.darkvision)sl.push('暗視 '+senses.darkvision+'ft');
  if(senses.blindsight)sl.push('盲目視 '+senses.blindsight+'ft');
  if(senses.tremorsense)sl.push('振動感知 '+senses.tremorsense+'ft');
  if(senses.truesight)sl.push('真実の目 '+senses.truesight+'ft');
  if(sl.length) h+=`<div style="font-size:12px;color:var(--tm);text-align:center;margin-top:6px">${sl.join(' · ')}</div>`;

  h+='</div>'; // end col3
  h+='</div>'; // end sheet-body

  // Personality
  const det=sys.details||{};
  const trait=det.trait||'';
  const ideal=det.ideal||'';
  const bond=det.bond||'';
  const flaw=det.flaw||'';
  if(trait||ideal||bond||flaw){
    h+='<div class="pers-grid">';
    h+=`<div class="pers-box"><div class="lbl">性格特徴</div><div class="ct">${trait||'—'}</div></div>`;
    h+=`<div class="pers-box"><div class="lbl">理想</div><div class="ct">${ideal||'—'}</div></div>`;
    h+=`<div class="pers-box"><div class="lbl">絆</div><div class="ct">${bond||'—'}</div></div>`;
    h+=`<div class="pers-box"><div class="lbl">弱点</div><div class="ct">${flaw||'—'}</div></div>`;
    h+='</div>';
  }

  // Proficiencies & Languages
  const traits=sys.traits||{};
  const langs=Array.isArray(traits.languages?.value)?traits.languages.value:[];
  const wProf=Array.isArray(traits.weaponProf?.value)?traits.weaponProf.value:[];
  const aProf=Array.isArray(traits.armorProf?.value)?traits.armorProf.value:[];
  if(langs.length||wProf.length||aProf.length){
    h+='<div class="sec"><div class="sec-title">習熟・言語</div><div class="pl-grid">';
    h+=`<div class="pl-grp"><div class="lbl">言語</div><div class="items">${langs.map(l=>'<span class="pill">'+l+'</span>').join('')||'—'}</div></div>`;
    h+=`<div class="pl-grp"><div class="lbl">武器習熟</div><div class="items">${wProf.map(w=>'<span class="pill">'+w+'</span>').join('')||'—'}</div></div>`;
    h+=`<div class="pl-grp"><div class="lbl">防具習熟</div><div class="items">${aProf.map(a=>'<span class="pill">'+a+'</span>').join('')||'—'}</div></div>`;
    h+='</div></div>';
  }

  // Features (with uses)
  const featTypes=new Set(['feat','class','race','background','subclass']);
  const allFeats=items.filter(i=>featTypes.has(i.type));
  if(allFeats.length){
    h+='<div class="sec"><div class="sec-title">特徴・特技</div>';
    for(const f of allFeats){
      if(f.type==='class'||f.type==='race'||f.type==='background'||f.type==='subclass') continue;
      const desc=tx(f.system?.description?.value);
      const short=desc.length>250?desc.substring(0,250)+'…':desc;
      const src=f.system?.requirements||f.type||'';
      const idx=items.indexOf(f);
      const uses=f.system?.uses;
      const hasUses=uses&&(uses.max||uses.value);
      let usesHtml='';
      if(hasUses){
        const uMax=uses.max||0;
        const uVal=uses.value||0;
        // uses.value = how many SPENT in some formats, or remaining in others.
        // In FVTT dnd5e: uses.value = remaining, uses.max = maximum
        usesHtml=`<span class="feat-uses">(${nc('e-num',`style="width:32px" data-action="set-uses" data-item-idx="${idx}"`,uVal,0,uMax)} / ${uMax})</span>`;
      }
      h+=`<div class="feat-item"><span class="fn">${tip(f.name,f.system?.description?.value)}</span>${usesHtml}<span class="fs">${src}</span>${short?'<div class="fd">'+short+'</div>':''}</div>`;
    }
    h+='</div>';
  }

  // Spells
  const spells=items.filter(i=>i.type==='spell');
  if(spells.length){
    h+='<div class="sec"><div class="sec-title">呪文</div>';

    // Spellcasting info
    const scAbil=sys.attributes?.spellcasting||'';
    if(scAbil){
      const scMod=getAbilMod(sys,scAbil);
      const dc=8+prof+scMod;
      const sAtk=prof+scMod;
      h+=`<div class="sp-meta"><div><b>呪文発動能力:</b> ${ABILS[scAbil]||scAbil.toUpperCase()}</div><div><b>呪文セーヴDC:</b> ${dc}</div><div><b>呪文攻撃:</b> ${fm(sAtk)}</div></div>`;
    }

    // Spell slots (editable)
    const slots=ensurePath(sys,'spells');
    const hasSlots=Object.keys(slots).some(k=>k.startsWith('spell')&&(slots[k]?.value>0||slots[k]?.override>0));
    if(hasSlots){
      h+='<div class="sp-slots">';
      for(let lv=1;lv<=9;lv++){
        const s=slots['spell'+lv];
        if(!s) continue;
        const max=s.override??s.value??0;
        if(!max) continue;
        const cur=s.value??0;
        h+=`<div class="sl-grp"><span class="lv">${lv}lv</span>`;
        for(let i=0;i<max;i++){
          h+=`<div class="sl-d ${i<cur?'on':''}" data-action="toggle-slot" data-slot-lv="${lv}" data-slot-idx="${i}"></div>`;
        }
        h+='</div>';
      }
      h+='</div>';
    }

    // Group by level
    const byLv=new Map();
    for(const sp of spells){
      const lv=sp.system?.level??0;
      if(!byLv.has(lv)) byLv.set(lv,[]);
      byLv.get(lv).push(sp);
    }
    const levels=[...byLv.keys()].sort((a,b)=>a-b);
    for(const lv of levels){
      const list=byLv.get(lv);
      const pretty=lv===0?'キャントリップ':'Lv'+lv;
      h+=`<details class="sp-lv"${lv<=1?' open':''}><summary>${pretty} (${list.length})</summary><div class="sp-lv-body">`;
      for(const sp of list){
        const ss=sp.system||{};
        const school=SCHOOLS[ss.school]||ss.school||'';
        const actType=ss.activation?.type||'';
        const range=ss.range?.value||ss.range||'';
        const dur=ss.duration?.value||(ss.duration?.units&&ss.duration.units!=='inst'?ss.duration.units:'')||'';
        const conc=ss.properties?.value?.includes?.('concentration')||ss.components?.concentration||false;
        const ritual=ss.properties?.value?.includes?.('ritual')||ss.components?.ritual||false;
        const prepared=ss.preparation?.prepared||ss.preparation?.mode==='always'||ss.preparation?.mode==='atwill'||lv===0;
        const canToggle=lv>0&&ss.preparation?.mode!=='always'&&ss.preparation?.mode!=='atwill';
        const tags=[school,actType,range?'射程:'+range:'',dur?'持続:'+dur:'',conc?'集中':'',ritual?'儀式':''].filter(Boolean).join(' · ');
        const idx=items.indexOf(sp);
        h+=`<div class="sp-entry"><span class="prep ${prepared?'':'off'}" ${canToggle?`data-action="toggle-prepared" data-item-idx="${idx}"`:''} ${canToggle?'title="クリックで準備切替"':''}>${prepared?'●':'○'}</span><span class="sn">${tip(sp.name,ss.description?.value)}</span><span class="sd">${tags}</span></div>`;
      }
      h+='</div></details>';
    }
    h+='</div>';
  }

  // Biography
  const bio=det.biography?.value||'';
  const appear=det.appearance||'';
  if(bio||appear){
    h+='<div class="sec"><div class="sec-title">経歴・外見</div>';
    if(appear) h+=`<div style="font-size:13px;color:var(--tm);margin-bottom:8px;white-space:pre-line">${appear}</div>`;
    if(bio) h+=`<div class="bio-ct">${bio}</div>`;
    h+='</div>';
  }

  $('#sheet').innerHTML=h;
  $('#sheet').classList.add('active');
  $('#dropzone').style.display='none';
  $('#exportBtn').style.display='inline-block';

  restoreDetailsState(detState);
  window.scrollTo(0,scrollY);
}

// --- Event Delegation ---
$('#sheet').addEventListener('click',e=>{
  const t=e.target;
  const action=t.dataset?.action;
  if(!action||!currentActor) return;
  const sys=currentActor.system;

  if(action==='toggle-inspiration'){
    const attr=ensurePath(sys,'attributes');
    attr.inspiration=!attr.inspiration;
    markDirty();render(currentActor);
  }

  if(action==='hp-dmg'||action==='hp-heal'){
    const input=document.getElementById('hpDelta');
    const delta=parseInt(input?.value)||0;
    if(delta<=0) return;
    const hp=ensurePath(sys,'attributes','hp');
    const max=hp.max??hp.value??0;
    if(action==='hp-dmg'){
      let dmg=delta;
      // Temp HP absorbs first
      const temp=hp.temp||0;
      if(temp>0){
        const absorbed=Math.min(temp,dmg);
        hp.temp=temp-absorbed;
        dmg-=absorbed;
      }
      hp.value=clamp((hp.value??0)-dmg,0,max);
    }else{
      hp.value=clamp((hp.value??0)+delta,0,max);
    }
    markDirty();render(currentActor);
  }

  if(action==='death-success'){
    const idx=parseInt(t.dataset.idx);
    const death=ensurePath(sys,'attributes','death');
    const cur=death.success||0;
    death.success=(idx<cur)?idx:idx+1;
    markDirty();render(currentActor);
  }
  if(action==='death-failure'){
    const idx=parseInt(t.dataset.idx);
    const death=ensurePath(sys,'attributes','death');
    const cur=death.failure||0;
    death.failure=(idx<cur)?idx:idx+1;
    markDirty();render(currentActor);
  }

  if(action==='hd-use'){
    const ci=parseInt(t.dataset.classIdx);
    const clsItems=(currentActor.items||[]).filter(i=>i.type==='class');
    const c=clsItems[ci];if(!c) return;
    const hd=ensurePath(c,'system','hd');
    const lvl=c.system?.levels||0;
    const spent=hd.spent||0;
    if(spent<lvl){hd.spent=spent+1;markDirty();render(currentActor);}
  }
  if(action==='hd-recover'){
    const ci=parseInt(t.dataset.classIdx);
    const clsItems=(currentActor.items||[]).filter(i=>i.type==='class');
    const c=clsItems[ci];if(!c) return;
    const hd=ensurePath(c,'system','hd');
    if((hd.spent||0)>0){hd.spent=(hd.spent||0)-1;markDirty();render(currentActor);}
  }

  if(action==='toggle-slot'){
    const lv=parseInt(t.dataset.slotLv);
    const idx=parseInt(t.dataset.slotIdx);
    const slots=ensurePath(sys,'spells');
    const key='spell'+lv;
    if(!slots[key]) slots[key]={value:0,override:0};
    const s=slots[key];
    const max=s.override??s.value??0;
    const cur=s.value??0;
    // Click on a filled dot = set value to that index (consume)
    // Click on an empty dot = set value to index+1 (restore)
    if(idx<cur) s.value=idx; else s.value=idx+1;
    s.value=clamp(s.value,0,max);
    markDirty();render(currentActor);
  }

  if(action==='toggle-prepared'){
    const idx=parseInt(t.dataset.itemIdx);
    const item=currentActor.items[idx];if(!item) return;
    const prep=ensurePath(item,'system','preparation');
    prep.prepared=!prep.prepared;
    markDirty();render(currentActor);
  }

  if(action==='toggle-equip'){
    const idx=parseInt(t.dataset.itemIdx);
    const item=currentActor.items[idx];if(!item) return;
    const s=ensurePath(item,'system');
    s.equipped=!s.equipped;
    markDirty();render(currentActor);
  }
});

// +/- button handler
$('#sheet').addEventListener('click',e=>{
  const btn=e.target.closest('[data-nc]');
  if(!btn) return;
  const wrap=btn.closest('.nc');
  const input=wrap?.querySelector('input[type=number]');
  if(!input) return;
  const step=parseInt(btn.dataset.nc)||0;
  const min=input.min!==''?parseInt(input.min):-Infinity;
  const max=input.max!==''?parseInt(input.max):Infinity;
  input.value=clamp((parseInt(input.value)||0)+step,min,max);
  input.dispatchEvent(new Event('change',{bubbles:true}));
});

// Number input changes (HP, temp, quantity, currency, uses)
$('#sheet').addEventListener('change',e=>{
  const t=e.target;
  const action=t.dataset?.action;
  if(!action||!currentActor) return;
  const sys=currentActor.system;
  const val=parseInt(t.value)||0;

  if(action==='set-hp'){
    const hp=ensurePath(sys,'attributes','hp');
    const max=hp.max??hp.value??999;
    hp.value=clamp(val,0,max);
    markDirty();render(currentActor);
  }
  if(action==='set-temp-hp'){
    const hp=ensurePath(sys,'attributes','hp');
    hp.temp=Math.max(0,val);
    markDirty();render(currentActor);
  }
  if(action==='set-quantity'){
    const idx=parseInt(t.dataset.itemIdx);
    const item=currentActor.items[idx];if(!item) return;
    ensurePath(item,'system').quantity=Math.max(0,val);
    markDirty();
  }
  if(action==='set-currency'){
    const coin=t.dataset.coin;
    const cur=ensurePath(sys,'currency');
    cur[coin]=Math.max(0,val);
    markDirty();
  }
  if(action==='set-uses'){
    const idx=parseInt(t.dataset.itemIdx);
    const item=currentActor.items[idx];if(!item) return;
    const uses=ensurePath(item,'system','uses');
    const max=uses.max||0;
    uses.value=clamp(val,0,max);
    markDirty();
  }
});

function markDirty(){
  dirty=true;
  const btn=$('#exportBtn');
  if(btn) btn.textContent='Export JSON *';
}

// --- Export ---
$('#exportBtn').addEventListener('click',()=>{
  if(!currentActor) return;
  const json=JSON.stringify(currentActor,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=(currentActor.name||'character').replace(/[^a-zA-Z0-9_\-\u3000-\u9fff]/g,'_')+'.json';
  a.click();
  URL.revokeObjectURL(url);
  dirty=false;
  $('#exportBtn').textContent='Export JSON';
});

// --- Actor selection ---
function populateSelect(actors){
  const sel=$('#actorSel');
  if(actors.length<=1){sel.style.display='none';return;}
  sel.style.display='inline-block';sel.innerHTML='';
  actors.forEach((a,i)=>{
    const o=document.createElement('option');
    o.value=i;o.textContent=(a.name||'(no name)')+' Lv'+(getLevel(a)||'?');
    sel.appendChild(o);
  });
  sel.onchange=()=>render(actors[+sel.value]);
}

function handleJson(text){
  let data;try{data=JSON.parse(text)}catch(e){alert('JSON解析に失敗');return;}
  currentActors=pickActors(data);
  dirty=false;
  $('#exportBtn').textContent='Export JSON';
  populateSelect(currentActors);
  render(currentActors[0]);
}

function readFile(f){const r=new FileReader();r.onload=e=>handleJson(e.target.result);r.readAsText(f,'utf-8');}

// Drag & drop
const dz=$('#dropzone');
['dragenter','dragover'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.add('drag')}));
['dragleave','drop'].forEach(e=>dz.addEventListener(e,ev=>{ev.preventDefault();dz.classList.remove('drag')}));
dz.addEventListener('drop',e=>{const f=e.dataTransfer.files?.[0];if(f)readFile(f)});
$('#file').addEventListener('click',function(){this.value=''});
$('#file').addEventListener('change',e=>{const f=e.target.files?.[0];if(f)readFile(f)});

// Demo
$('#demoBtn').addEventListener('click',()=>{
  handleJson(JSON.stringify({
    name:"Melissa the Heretic",type:"character",
    system:{
      details:{level:5,race:"Human",alignment:"Lawful Good",
        trait:"信仰に篤く、困っている人を見過ごせない。",
        ideal:"癒し：傷ついた者を癒すことが自分の使命。",
        bond:"幼い頃に救ってくれた神官への恩義を忘れない。",
        flaw:"頑固で、一度決めたことを曲げようとしない。",
        biography:{value:"<p>元シーク教徒。ヘイヴンの神殿で、シーク教徒が隠していた「異端の力」に触れ、まことのクレリックとなる。</p><p>それが元でシーカー評議会で異端審問にかけられ、辺境の村ソレースに逃げて来たのだが...</p>"},
        appearance:"Gender: Female\nEyes: Dark Blue\nHair: Brown\nHeight: 5'2''"
      },
      abilities:{str:{value:14,mod:2,proficient:0},dex:{value:16,mod:3,proficient:1},con:{value:14,mod:2,proficient:0},int:{value:10,mod:0,proficient:0},wis:{value:18,mod:4,proficient:1},cha:{value:12,mod:1,proficient:0}},
      skills:{prc:{value:1,ability:'wis'},per:{value:1,ability:'cha'},ste:{value:1,ability:'dex'},med:{value:2,ability:'wis'},ins:{value:1,ability:'wis'},rel:{value:1,ability:'int'}},
      attributes:{ac:{value:17},hp:{value:36,max:36,temp:0},prof:3,movement:{walk:30},senses:{darkvision:0},speed:{value:30},
        death:{success:0,failure:0},inspiration:false,spellcasting:'wis'},
      traits:{languages:{value:["Common","Elvish","Dwarvish"]},weaponProf:{value:["sim"]},armorProf:{value:["lgt","med","shl"]}},
      spells:{spell1:{value:4,override:4},spell2:{value:3,override:3},spell3:{value:2,override:2}},
      currency:{pp:2,gp:45,ep:0,sp:12,cp:30},
      resources:{primary:{value:2,max:3,sr:false,lr:true,label:"Channel Divinity"}}
    },
    items:[
      {type:'class',name:'Cleric',system:{levels:5,hd:{denomination:'d8',spent:1},identifier:'cleric',spellcasting:{progression:'full',ability:'wis'}}},
      {type:'subclass',name:'Life Domain',system:{classIdentifier:'cleric'}},
      {type:'race',name:'Human',system:{}},
      {type:'background',name:'Acolyte',system:{}},
      {type:'weapon',name:'Mace',system:{ability:'str',proficient:true,attackBonus:0,damage:{parts:[["1d6+2","bludgeoning"]]},properties:{},description:{value:'A simple melee weapon. 1d6 bludgeoning damage.'}}},
      {type:'weapon',name:'Light Crossbow',system:{ability:'dex',proficient:true,attackBonus:0,damage:{parts:[["1d8+3","piercing"]]},properties:{amm:true,lod:true},description:{value:'A simple ranged weapon. 1d8 piercing damage. Ammunition (range 80/320), loading, two-handed.'}}},
      {type:'equipment',name:'Chain Shirt',system:{quantity:1,equipped:true,armor:{value:13,type:'medium'},description:{value:"Medium armor, AC 13 + DEX (max 2)."}}},
      {type:'equipment',name:'Shield',system:{quantity:1,equipped:true,armor:{value:2,type:'shield'},description:{value:"+2 AC."}}},
      {type:'feat',name:'Channel Divinity',system:{uses:{value:2,max:3},description:{value:'Turn Undead or Preserve Life.'}}},
      {type:'feat',name:'Disciple of Life',system:{description:{value:'Healing spells restore additional HP equal to 2 + spell level.'}}},
      {type:'feat',name:'Blessed Healer',system:{description:{value:'When you cast a healing spell on another, you also regain HP.'}}},
      {type:'consumable',name:'Holy Water',system:{quantity:3,description:{value:'Splash weapon dealing 2d6 radiant to fiends/undead.'}}},
      {type:'tool',name:'Medallion of Mishakal',system:{quantity:1,description:{value:'A blue crystal medallion, holy symbol of Mishakal, goddess of healing.'}}},
      {type:'tool',name:"Priest's Pack",system:{quantity:1,weight:29,description:{value:'Includes a backpack, blanket, candles, tinderbox, alms box, incense, censer, vestments, rations, and a waterskin.'}}},
      {type:'spell',name:'Guidance',system:{level:0,school:'div',activation:{type:'Action',cost:1},range:{value:'Touch'},duration:{value:'1 min'},description:{value:'Add 1d4 to an ability check.'},preparation:{prepared:true}}},
      {type:'spell',name:'Sacred Flame',system:{level:0,school:'evo',activation:{type:'Action',cost:1},range:{value:'60 ft'},duration:{units:'inst'},description:{value:'DEX save or 2d8 radiant damage.'},preparation:{prepared:true}}},
      {type:'spell',name:'Spare the Dying',system:{level:0,school:'nec',activation:{type:'Action',cost:1},range:{value:'Touch'},duration:{units:'inst'},description:{value:'Stabilize a creature at 0 HP.'},preparation:{prepared:true}}},
      {type:'spell',name:'Bless',system:{level:1,school:'enc',activation:{type:'Action',cost:1},range:{value:'30 ft'},duration:{value:'1 min'},description:{value:'Up to 3 creatures add 1d4 to attacks/saves.'},preparation:{prepared:true,mode:'prepared'},properties:{value:['concentration']}}},
      {type:'spell',name:'Cure Wounds',system:{level:1,school:'evo',activation:{type:'Action',cost:1},range:{value:'Touch'},duration:{units:'inst'},description:{value:'Heal 1d8 + WIS mod HP.'},preparation:{prepared:true,mode:'prepared'}}},
      {type:'spell',name:'Shield of Faith',system:{level:1,school:'abj',activation:{type:'Bonus',cost:1},range:{value:'60 ft'},duration:{value:'10 min'},description:{value:'+2 AC to target.'},preparation:{prepared:true,mode:'prepared'},properties:{value:['concentration']}}},
      {type:'spell',name:'Healing Word',system:{level:1,school:'evo',activation:{type:'Bonus',cost:1},range:{value:'60 ft'},duration:{units:'inst'},description:{value:'Heal 1d4 + WIS mod HP as bonus action.'},preparation:{prepared:true,mode:'prepared'}}},
      {type:'spell',name:'Spiritual Weapon',system:{level:2,school:'evo',activation:{type:'Bonus',cost:1},range:{value:'60 ft'},duration:{value:'1 min'},description:{value:'Create spectral weapon. 1d8 + WIS force damage.'},preparation:{prepared:true,mode:'prepared'}}},
      {type:'spell',name:'Lesser Restoration',system:{level:2,school:'abj',activation:{type:'Action',cost:1},range:{value:'Touch'},duration:{units:'inst'},description:{value:'End one disease or condition.'},preparation:{prepared:true,mode:'prepared'}}},
      {type:'spell',name:'Spirit Guardians',system:{level:3,school:'con',activation:{type:'Action',cost:1},range:{value:'Self (15ft)'},duration:{value:'10 min'},description:{value:'Spirits guard you. Enemies take 3d8 radiant.'},preparation:{prepared:true,mode:'prepared'},properties:{value:['concentration']}}},
      {type:'spell',name:'Revivify',system:{level:3,school:'nec',activation:{type:'Action',cost:1},range:{value:'Touch'},duration:{units:'inst'},description:{value:'Return creature dead within 1 minute to life with 1 HP.'},preparation:{prepared:true,mode:'prepared'}}}
    ]
  }));
});

// Warn on unsaved
window.addEventListener('beforeunload',e=>{
  if(dirty){e.preventDefault();e.returnValue='';}
});
// ブラウザの遷移対策
(() => {
  window.addEventListener('beforeunload', (e) => {
    e.preventDefault();
    e.returnValue = '';
  });

  const pushGuard = () => history.pushState({ __guard: true, t: Date.now() }, '', location.href);
  history.replaceState({ __base: true }, '', location.href);
  pushGuard();
  window.addEventListener('pageshow', (e) => {
    if (e.persisted) pushGuard();
  });
  const armWithUserActivation = () => pushGuard();
  window.addEventListener('pointerdown', armWithUserActivation, { once: true, capture: true });
  window.addEventListener('keydown', armWithUserActivation, { once: true, capture: true });
  window.addEventListener('popstate', () => {
    history.go(1);
    setTimeout(pushGuard, 0);
  });

})();
</script>


<deepl-input-controller translate="no"><template shadowrootmode="open"><link rel="stylesheet" href="chrome-extension://cofdbpoegempjloogbagkncekinflcnj/build/content.css"><div dir="ltr" style="visibility: initial !important;"><div class="dl-input-translation-container svelte-95aucy"><div></div></div></div></template></deepl-input-controller></body><deepl-inline-trigger translate="no" style="z-index: 2147483639;"><template shadowrootmode="open"><link rel="stylesheet" href="chrome-extension://cofdbpoegempjloogbagkncekinflcnj/build/content.css"><div style="position: absolute; top: 0px; left: 0px; width: 100%; z-index: 2147483139; visibility: initial !important;"><div style="position: absolute; z-index: 2147483139; top: 134px; left: 808px;"><div dir="ltr"> <div class="layout-container svelte-552fez"> <div class="icon-container svelte-552fez" data-testid="deepl-inline-translate-icon-container" role="group"><div data-tooltip="オフにする" style="--tooltip-z-index: 2147483639; " class="svelte-1yqkvai"><div data-testid="deepl-advanced-trigger-turnoff-icon" class="dl-turnoff-inline-icon svelte-552fez advanced hidden left"></div></div> <div data-tooltip="DeepLでテキストを推敲" style="--tooltip-z-index: 2147483639; " class="svelte-1yqkvai"><div class="dl-inline-icon dl-write-icon svelte-15hlb3a" data-testid="deepl-advanced-trigger-write-icon" data-qa="deepl-inline-translate-menu-icon"></div></div> <div data-tooltip="DeepLで翻訳 (Ctrl+Shift+Y)" style="--tooltip-z-index: 2147483639; " class="svelte-1yqkvai showProShield"><div class="dl-inline-icon dl-translate-icon svelte-552fez" data-testid="dl-advanced-trigger-translate-icon" data-qa="deepl-inline-translate-menu-icon"></div></div> </div></div></div></div></div></template></deepl-inline-trigger></html>